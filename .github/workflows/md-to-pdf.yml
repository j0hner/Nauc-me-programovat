name: Markdown to PDF

on:
  push:
    paths:
      - 'markdown/**'

permissions:
  contents: write

env:
  MD_FOLDER: markdown
  PDF_FOLDER: pdf
  CSS_FILE: style.css

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      # Checkout full repo history (required for branch operations)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # Install WeasyPrint and system dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-cairo \
            python3-gi \
            python3-gi-cairo \
            gir1.2-pango-1.0 \
            gir1.2-gdkpixbuf-2.0
          pip install --upgrade pip
          pip install weasyprint

      # Install Pandoc
      - name: Install Pandoc (latest)
        run: |
          PANDOC_VERSION=3.8.3
          wget https://github.com/jgm/pandoc/releases/download/${PANDOC_VERSION}/pandoc-${PANDOC_VERSION}-1-amd64.deb
          sudo dpkg -i pandoc-${PANDOC_VERSION}-1-amd64.deb
          rm pandoc-${PANDOC_VERSION}-1-amd64.deb

      # Convert Markdown → HTML → PDF (incremental)
      - name: Convert Markdown to PDF
        run: |
          set -e

          mkdir -p "$GITHUB_WORKSPACE/$PDF_FOLDER"

          # Get changed files in this push
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)

          CSS_CHANGED=false
          MD_FILES=""

          # Detect CSS change
          if echo "$CHANGED_FILES" | grep -q "^.github/$CSS_FILE$"; then
            CSS_CHANGED=true
          fi

          if [ "$CSS_CHANGED" = true ]; then
            echo "CSS changed → rebuilding all markdown files"
            MD_FILES=$(find "$MD_FOLDER" -type f -name "*.md")
          else
            echo "CSS unchanged → building only changed markdown files"
            MD_FILES=$(echo "$CHANGED_FILES" | grep "^$MD_FOLDER/.*\.md$" || true)
          fi

          for mdfile in $MD_FILES; do
            [ -f "$mdfile" ] || continue

            relpath="${mdfile#$MD_FOLDER/}"
            outdir="$GITHUB_WORKSPACE/$PDF_FOLDER/$(dirname "$relpath")"
            filename="$(basename "$mdfile" .md)"

            mkdir -p "$outdir"

            pandoc "$mdfile" \
              -o "$outdir/$filename.html" \
              --syntax-highlighting=pygments \
              --standalone \
              --css "$GITHUB_WORKSPACE/.github/$CSS_FILE"

            python -m weasyprint \
              "$outdir/$filename.html" \
              "$outdir/$filename.pdf"

            rm "$outdir/$filename.html"
          done

      # Push PDFs into dedicated branch
      - name: Push PDFs to pdfs branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Make sure the branch exists
          git fetch origin
          git checkout --orphan pdfs

          # Remove everything except .git
          git rm -rf .

          # Check if PDF folder exists
          if [ -d "$GITHUB_WORKSPACE/$PDF_FOLDER" ]; then
            mkdir -p pdfs
            cp -r "$GITHUB_WORKSPACE/$PDF_FOLDER"/* pdfs/
          else
            echo "No PDFs found, skipping copy"
          fi

          echo "# PDFs branch" > README.md
          echo "Na téhle branchi jsou k nalezení pdf verze dokumentů z adresáře markdown" >> README.md
          git add README.md

          # Commit and push
          git add pdfs || true
          git commit -m "Update PDFs" || true
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin pdfs --force

      # Upload PDFs as workflow artifacts
      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: markdown-pdfs
          path: .
