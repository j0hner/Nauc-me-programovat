name: Markdown to PDF

on:
  push:
    paths:
      - 'markdown/**'
      - '.github/**'

permissions:
  contents: write

env:
  MD_FOLDER: markdown
  PDF_FOLDER: pdf
  CSS_FILE: style.css

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      # Checkout full repo history (required for branch operations)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # Install WeasyPrint and system dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-cairo \
            python3-gi \
            python3-gi-cairo \
            gir1.2-pango-1.0 \
            gir1.2-gdkpixbuf-2.0
          pip install --upgrade pip
          pip install weasyprint

      # Install Pandoc
      - name: Install Pandoc (latest)
        run: |
          PANDOC_VERSION=3.8.3
          wget https://github.com/jgm/pandoc/releases/download/${PANDOC_VERSION}/pandoc-${PANDOC_VERSION}-1-amd64.deb
          sudo dpkg -i pandoc-${PANDOC_VERSION}-1-amd64.deb
          rm pandoc-${PANDOC_VERSION}-1-amd64.deb

      # Convert Markdown → HTML → PDF (incremental)
      - name: Convert Markdown to PDF
        run: |
          set -e
      
          mkdir -p "$GITHUB_WORKSPACE/$PDF_FOLDER"
          mkdir -p "$GITHUB_WORKSPACE/hashes"
          mkdir -p /tmp/pandoc
      
          hash_file() {
            sha256sum "$1" | awk '{print $1}'
          }
      
          CHANGED=$(git diff --name-status HEAD~1 HEAD || true)
      
          CSS_CHANGED=false
          if echo "$CHANGED" | grep -q "^M[[:space:]].github/$CSS_FILE$"; then
            CSS_CHANGED=true
          fi
      
          # Handle renames
          echo "$CHANGED" | awk '$1 ~ /^R/ {print $2 "|" $3}' | while IFS="|" read old new; do
            old_rel="${old#$MD_FOLDER/}"
            new_rel="${new#$MD_FOLDER/}"
      
            old_pdf="$PDF_FOLDER/${old_rel%.md}.pdf"
            new_pdf="$PDF_FOLDER/${new_rel%.md}.pdf"
      
            old_hash="hashes/${old_rel%.md}.hash"
            new_hash="hashes/${new_rel%.md}.hash"
      
            if [ -f "$old_pdf" ]; then
              mkdir -p "$(dirname "$new_pdf")" "$(dirname "$new_hash")"
              mv "$old_pdf" "$new_pdf"
              mv "$old_hash" "$new_hash" 2>/dev/null || true
            fi
          done
      
          if [ "$CSS_CHANGED" = true ]; then
            MD_FILES=$(find "$MD_FOLDER" -type f -name "*.md")
          else
            MD_FILES=$(echo "$CHANGED" | awk '$1 ~ /^[AM]/ {print $2}' | grep "^$MD_FOLDER/.*\.md$" || true)
          fi
      
          for mdfile in $MD_FILES; do
            [ -f "$mdfile" ] || continue
      
            rel="${mdfile#$MD_FOLDER/}"
            base="$(basename "$mdfile" .md)"
      
            pdf_out="$PDF_FOLDER/$(dirname "$rel")/$base.pdf"
            hash_out="hashes/$(dirname "$rel")/$base.hash"
      
            mkdir -p "$(dirname "$pdf_out")" "$(dirname "$hash_out")"
      
            new_hash=$(hash_file "$mdfile")
      
            if [ "$CSS_CHANGED" = false ] && [ -f "$hash_out" ] && [ "$(cat "$hash_out")" = "$new_hash" ]; then
              continue
            fi
      
            LAST_UPDATED=$(git log -1 --date=short --format="%cd" -- "$mdfile")
      
            sed -e "s/\$LAST_UPDATED\$/$LAST_UPDATED/g" \
              "$GITHUB_WORKSPACE/.github/footer.html" \
              > /tmp/pandoc/footer.html
      
            
            echo $mdfile
            
            pandoc "$mdfile" \
              -o "$pdf_out.html" \
              --standalone \
              --syntax-highlighting=pygments \
              --css "$GITHUB_WORKSPACE/.github/$CSS_FILE" \
              --include-after-body /tmp/pandoc/footer.html
      
            python -m weasyprint \
              "$pdf_out.html" \
              "$pdf_out"
      
            rm "$pdf_out.html"
            echo "$new_hash" > "$hash_out"
          done


      # Push PDFs + hashes into dedicated branch
      - name: Push PDFs to pdfs branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # --- stash artifacts OUTSIDE the repo ---
          rm -rf /tmp/pdfs /tmp/hashes
          mkdir -p /tmp/pdfs /tmp/hashes
          
          ls "$GITHUB_WORKSPACE/$PDF_FOLDER"
          cp -r "$GITHUB_WORKSPACE/$PDF_FOLDER" /tmp/pdfs/
          cp -r "$GITHUB_WORKSPACE/hashes" /tmp/hashes/
      
          # --- switch to orphan branch ---
          git fetch origin
          git checkout --orphan pdfs
      
          # wipe working tree
          git rm -rf .
      
          # --- restore artifacts ---
          mkdir -p pdfs hashes
          cp -r /tmp/pdfs/ .pdfs/
          cp -r /tmp/hashes/ .hashes/
      
          echo "# PDFs branch" > README.md
          echo "Automaticky generované PDF verze dokumentů z adresáře markdown." >> README.md
      
          git add pdfs hashes README.md
          git commit -m "Update PDFs"
      
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin pdfs --force

      # Upload PDFs as workflow artifacts
      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: markdown-pdfs
          path: .
