name: Markdown to PDF

on:
  push:
    paths:
      - 'markdown/**'

permissions:
  contents: write

env:
  MD_FOLDER: markdown
  PDF_FOLDER: pdf
  CSS_FILE: style.css

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      # Checkout full repo history (required for branch operations)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # Install WeasyPrint and system dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-cairo \
            python3-gi \
            python3-gi-cairo \
            gir1.2-pango-1.0 \
            gir1.2-gdkpixbuf-2.0
          pip install --upgrade pip
          pip install weasyprint

      # Install Pandoc
      - name: Install Pandoc (latest)
        run: |
          PANDOC_VERSION=3.8.3
          wget https://github.com/jgm/pandoc/releases/download/${PANDOC_VERSION}/pandoc-${PANDOC_VERSION}-1-amd64.deb
          sudo dpkg -i pandoc-${PANDOC_VERSION}-1-amd64.deb
          rm pandoc-${PANDOC_VERSION}-1-amd64.deb

      # Convert Markdown → HTML → PDF
      - name: Convert Markdown to PDF
        run: |
          mkdir -p "$GITHUB_WORKSPACE/$PDF_FOLDER"

          for mdfile in "$MD_FOLDER"/*.md; do
            filename=$(basename "$mdfile" .md)

            pandoc "$mdfile" \
              -o "$GITHUB_WORKSPACE/$PDF_FOLDER/$filename.html" \
              --syntax-highlighting=pygments \
              --standalone \
              --css "$GITHUB_WORKSPACE/.github/$CSS_FILE"

            python -m weasyprint \
              "$GITHUB_WORKSPACE/$PDF_FOLDER/$filename.html" \
              "$GITHUB_WORKSPACE/$PDF_FOLDER/$filename.pdf"

            rm "$GITHUB_WORKSPACE/$PDF_FOLDER/$filename.html"
          done

      # Push PDFs into dedicated branch
      - name: Push PDFs to pdfs branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git checkout -B pdfs
          git rm -rf . || true
          git clean -fdx

          git add .
          git commit -m "Update PDFs" || true

          git remote set-url origin \
            https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git

          git push origin pdfs --force

      # Upload PDFs as workflow artifacts
      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: markdown-pdfs
          path: .
